!function(a){"use strict";function c(c,d){function o(a){return String(a).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function p(b,c){var d='<div class="photo-editor row"><div class="col-xs-12"><img src="'+o(c)+'"  style="max-width:100%;"></div></div>';return a(d)}function r(b,c,d,e){var f=a(q);return g[b]=f,f.data("id",b),f.data("rank",d),f.attr("data-key",b),f.attr("data-rank",d),a("img",f).attr("src",c),e?j.prepend(f):j.append(f),f}function s(b){for(var c=b.length,d=n.empty(),e=0;e<c;e++){var f=b[e],h=g[f],i=a("img",h).attr("src");d.append(p(f,i))}c>0&&k.modal("show")}function t(b){a.ajax({type:"POST",url:e.deleteUrl,data:"id[]="+b.join("&id[]=")+f,success:function(a){if("OK"==a)for(var c=0,d=b.length;c<d;c++)g[b[c]].remove(),delete g[b[c]];else alert(a)}})}function u(b){b.preventDefault();var c=a(this).closest(".photo"),d=c.data("id");return t([d]),!1}function v(b){b.preventDefault();var c=a(this).closest(".photo"),d=c.data("id");return s([d]),!1}function w(){var b=a(".photo.selected",i).length;a(".select_all",h).prop("checked",a(".photo",i).length==b),0==b?a(".edit_selected, .remove_selected",h).addClass("disabled"):a(".edit_selected, .remove_selected",h).removeClass("disabled")}function x(){var b=a(this);b.is(":checked")?b.closest(".photo").addClass("selected"):b.closest(".photo").removeClass("selected"),w()}var e=a.extend({},b,d),f=e.csrfToken?"&"+e.csrfTokenName+"="+e.csrfToken:"",g={},h=a(c);h.addClass("no-name"),h.addClass("no-desc");var i=a(".sorter",h),j=a(".images",i),k=a(".editor-modal",h),l=a(".progress-overlay",h),m=a(".upload-progress",l),n=a(".form",k),q='<div class="photo"><div class="image-preview"><img src=""/></div><div class="caption">';if(q+='</div><div class="actions">',q+='<span class="deletePhoto btn btn-danger btn-xs"><i class="glyphicon glyphicon-remove glyphicon-white"></i></span></div><input type="checkbox" class="photo-select"/></div>',j.on("click",".photo .deletePhoto",u).on("click",".photo .editPhoto",v).on("click",".photo .photo-select",x),a(".images",i).sortable({tolerance:"pointer"}).disableSelection().bind("sortstop",function(){var b=[];a(".photo",i).each(function(){var c=a(this);b.push("order["+c.data("id")+"]="+c.data("rank"))}),a.ajax({type:"POST",url:e.arrangeUrl,data:b.join("&")+f,dataType:"json"}).done(function(a){for(var b in a[b])g[b].data("rank",a[b])})}),void 0!==window.FormData){var y=a(".afile",h).attr("name"),z=function(a){if(0!=a.length){l.show(),m.css("width","5%");for(var b=a.length,c=0,d=[],f=0;f<b;f++){var g=new FormData;g.append(y,a[f]),e.csrfToken&&g.append(e.csrfTokenName,e.csrfToken);var h=new XMLHttpRequest;h.open("POST",e.uploadUrl,!0),h.onload=function(){if(c++,200==this.status){var a=JSON.parse(this.response);r(a.id,a.preview,a.rank,e.prepend),d.push(a.id)}m.css("width",""+(5+95*c/b)+"%"),c===b&&(m.css("width","100%"),l.hide())},h.send(g)}}};!function(){function d(a){return a.preventDefault(),b=!0,!1}function e(){return b=!1,!1}function f(a){a.preventDefault(),a.stopPropagation();var c=a.dataTransfer.files;return z(c),b=!1,!1}function g(){b=!1}var a=h[0],b=!1,c=!1;setInterval(function(){b!=c&&(b?a.classList.add("over"):a.classList.remove("over"),c=b)},30),a.addEventListener("dragover",d,!1),a.addEventListener("dragleave",e,!1),a.addEventListener("drop",f,!1),a.addEventListener("dragend",g,!1)}(),a(".afile",h).attr("multiple","true").on("change",function(a){a.preventDefault(),z(this.files)})}else a(".afile",h).on("change",function(b){b.preventDefault();var c=[];l.show(),m.css("width","5%");var d={};e.csrfToken&&(d[e.csrfTokenName]=e.csrfToken),a.ajax({type:"POST",url:e.uploadUrl,data:d,files:a(this),iframe:!0,processData:!1,dataType:"json"}).done(function(a){r(a.id,a.preview,a.rank,e.prepend),c.push(a.id),m.css("width","100%"),l.hide()})});a(".save-changes",k).click(function(b){b.preventDefault(),a.post(e.updateUrl,a("input, textarea",n).serialize()+f,function(b){for(var c=b.length,d=0;d<c;d++){var e=b[d],f=g[e.id];a("img",f).attr("src",e.src)}k.modal("hide"),a(".photo.selected",i).each(function(){a(".photo-select",this).prop("checked",!1)}).removeClass("selected"),a(".select_all",h).prop("checked",!1),w()},"json")}),a(".edit_selected",h).click(function(b){b.preventDefault();var c=[];return a(".photo.selected",i).each(function(){c.push(a(this).data("id"))}),s(c),!1}),a(".remove_selected",h).click(function(b){b.preventDefault();var c=[];a(".photo.selected",i).each(function(){c.push(a(this).data("id"))}),t(c)}),a(".select_all",h).change(function(){a(this).prop("checked")?a(".photo",i).each(function(){a(".photo-select",this).prop("checked",!0)}).addClass("selected"):a(".photo.selected",i).each(function(){a(".photo-select",this).prop("checked",!1)}).removeClass("selected"),w()});for(var A=0,B=e.photos.length;A<B;A++){var C=e.photos[A];r(C.id,C.preview,C.rank)}}var b={csrfToken:a("meta[name=csrf-token]").attr("content"),csrfTokenName:a("meta[name=csrf-param]").attr("content"),uploadUrl:"",deleteUrl:"",updateUrl:"",arrangeUrl:"",prepend:!1,photos:[]};a.fn.galleryManager=function(a){this.length&&this.each(function(){c(this,a)})}}(jQuery);